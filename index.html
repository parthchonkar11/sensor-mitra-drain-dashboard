<!DOCTYPE html>
<html>
<head>
<title>Sensor Mitra - Professional Monitoring</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { background:#0b1220; font-family:Arial; color:white; margin:0; }
.top { text-align:center; padding:20px; background:#111827; }
.tabs { display:flex; justify-content:center; background:#020617; position:relative; }
.tab { padding:12px 20px; cursor:pointer; color:#9ca3af; }
.tab.active { background:#111827; border-radius:10px; color:white; }
.soundBtn { position:absolute; right:150px; top:50%; transform:translateY(-50%); padding:6px 14px; border-radius:10px; border:none; background:#334155; color:white; cursor:pointer; font-weight:bold; }
.alertBtn { position:absolute; right:15px; top:50%; transform:translateY(-50%); padding:6px 14px; border-radius:10px; border:none; background:#334155; color:white; cursor:pointer; font-weight:bold; transition:0.3s;}
.section { display:none; padding:30px; }
.section.active { display:block; }
.grid { display:flex; gap:20px; justify-content:center; flex-wrap:wrap; }
.card { background:linear-gradient(180deg,#0f172a,#020617); width:280px; padding:25px; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,.6); position:relative; transition: 0.3s; border: 1px solid #1e293b; }
.badge { position:absolute; top:20px; right:20px; padding:5px 12px; border-radius:20px; font-size:12px; }
.online{background:#16a34a;color:black;}
.offline{background:#6b7280;}
.dot { width:12px;height:12px;border-radius:50%;margin:0 auto 10px;background:#22c55e;}
.big{font-size:42px;font-weight:bold;}
.value{opacity:.85;margin:6px 0;}
.time{font-size:12px;opacity:.6;}

/* Animations */
.criticalCard { animation:blinkRed 0.8s infinite; border-color: #ef4444; }
@keyframes blinkRed {0%{box-shadow:0 0 0 red;} 50%{box-shadow:0 0 30px red;} 100%{box-shadow:0 0 0 red;}}
.warningCard { animation: blinkYellow 1.5s infinite; border-color: #facc15; }
@keyframes blinkYellow {0%{box-shadow:0 0 0 #facc15;} 50%{box-shadow:0 0 25px #facc15;} 100%{box-shadow:0 0 0 #facc15;}}

.chartBox { background:#020617; padding:20px; border-radius:20px; margin-top:20px; height:300px; }
select { background: #1f2937; color: white; border: 1px solid #374151; padding: 5px; border-radius: 5px; }
</style>
</head>

<body>

<div class="top"><h1>Sensor Mitra</h1></div>

<div class="tabs">
  <div class="tab active" onclick="showTab('summary',this)">SUMMARY</div>
  <div class="tab" onclick="showTab('trends',this)">TRENDS</div>
  <button class="soundBtn" id="soundBtn" onclick="toggleSound()">ðŸ”‡ Sound OFF</button>
  <button class="alertBtn" id="alertBtn" onclick="toggleAlerts()">ðŸ“² Alerts OFF</button>
</div>

<div id="summary" class="section active">
  <div class="grid">
    <div class="card" id="card1"><div class="badge offline" id="b1">OFFLINE</div><h3>Node1</h3><div style="text-align:center"><div class="dot" id="dot1"></div><div class="big" id="score1">--</div><div id="status1">WAITING</div><div class="value">Water: <span id="water1">--</span> cm</div><div class="value">Gas: <span id="gas1">--</span></div><div class="time">Last: <span id="time1">--</span></div></div></div>
    <div class="card" id="card2"><div class="badge offline" id="b2">OFFLINE</div><h3>Node2</h3><div style="text-align:center"><div class="dot" id="dot2"></div><div class="big" id="score2">--</div><div id="status2">WAITING</div><div class="value">Water: <span id="water2">--</span> cm</div><div class="value">Gas: <span id="gas2">--</span></div><div class="time">Last: <span id="time2">--</span></div></div></div>
    <div class="card" id="card3"><div class="badge offline" id="b3">OFFLINE</div><h3>Node3</h3><div style="text-align:center"><div class="dot" id="dot3"></div><div class="big" id="score3">--</div><div id="status3">WAITING</div><div class="value">Water: <span id="water3">--</span> cm</div><div class="value">Gas: <span id="gas3">--</span></div><div class="time">Last: <span id="time3">--</span></div></div></div>
  </div>
</div>

<div id="trends" class="section">
  <h2>Node Analysis</h2>
  <select id="nodeSelect" onchange="updateCharts()">
    <option value="node1">Node1</option>
    <option value="node2">Node2</option>
    <option value="node3">Node3</option>
  </select>
  <button onclick="downloadCSV()" style="margin-left:10px;padding:6px 12px;border-radius:8px;border:none;background:#16a34a;color:black;cursor:pointer;">Download CSV</button>
  <div class="chartBox"><canvas id="waterChart"></canvas></div>
  <div class="chartBox"><canvas id="gasChart"></canvas></div>
  <div class="chartBox"><canvas id="healthChart"></canvas></div>
</div>

<script>
function showTab(id,el){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
}

/* ---------- FIXED SOUND SYSTEM ---------- */
let audioCtx = null, soundEnabled = false;
let warningInterval = null, criticalInterval = null;

async function toggleSound() {
  const btn = document.getElementById("soundBtn");
  if (!soundEnabled) {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') await audioCtx.resume();
    soundEnabled = true;
    btn.innerText = "ðŸ”” Sound ON"; btn.style.background = "#16a34a";
  } else {
    stopAllBeeps();
    soundEnabled = false;
    btn.innerText = "ðŸ”‡ Sound OFF"; btn.style.background = "#334155";
  }
}

function singleBeep(freq, duration) {
  if (!audioCtx || !soundEnabled || audioCtx.state !== 'running') return;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain); gain.connect(audioCtx.destination);
  osc.frequency.value = freq;
  osc.start();
  gain.gain.setValueAtTime(0.1, audioCtx.currentTime); 
  gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration/1000);
  osc.stop(audioCtx.currentTime + duration/1000);
}

function startWarningBeep() { 
  if(warningInterval || criticalInterval) return; 
  warningInterval = setInterval(() => singleBeep(600, 200), 2000); 
}
function startCriticalBeep() { 
  if(criticalInterval) return; 
  clearInterval(warningInterval); warningInterval = null;
  criticalInterval = setInterval(() => singleBeep(1000, 300), 400); 
}
function stopAllBeeps() { 
  clearInterval(warningInterval); clearInterval(criticalInterval); 
  warningInterval = null; criticalInterval = null; 
}

/* ---------- TELEGRAM ---------- */
let alertsEnabled=false;
let alertSent={node1:{warning:false,critical:false},node2:{warning:false,critical:false},node3:{warning:false,critical:false}};
const BOT_TOKEN = "8416816090:AAFwaFRrhX0FD2iGtwSegBJeywEZBGGeA_E";
const CHAT_ID = "1842148990";

function sendTelegram(msg){
  fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${CHAT_ID}&text=${encodeURIComponent(msg)}`);
}

function toggleAlerts(){
  alertsEnabled=!alertsEnabled;
  const btn=document.getElementById("alertBtn");
  if(alertsEnabled){
    btn.innerText="ðŸ“² Alerts ON"; btn.style.background="#16a34a";
    sendTelegram(`ðŸš€ Sensor Mitra System Armed!\nTime: ${new Date().toLocaleTimeString()}`);
  } else {
    btn.innerText="ðŸ“² Alerts OFF"; btn.style.background="#334155";
  }
}

/* ---------- MQTT ---------- */
const client = mqtt.connect("wss://f9701c3f73584118b7abd579e55728af.s1.eu.hivemq.cloud:8884/mqtt", { username:"Node1234", password:"Node1234" });
let lastSeen={node1:0,node2:0,node3:0};
let history={node1:{t:[],w:[],g:[],h:[]},node2:{t:[],w:[],g:[],h:[]},node3:{t:[],w:[],g:[],h:[]}};

client.on("connect",()=>client.subscribe("smartdrain/#"));

client.on("message",(t,m)=>{
  const d=JSON.parse(m.toString());
  const node=d.node.toLowerCase();
  const n=node.replace("node","");
  const now = Date.now();
  const timeNow = new Date().toLocaleTimeString();
  lastSeen[node]=now;

  document.getElementById("water"+n).innerText=d.water.toFixed(1);
  document.getElementById("time"+n).innerText=timeNow;
  document.getElementById("b"+n).innerText="ONLINE";
  document.getElementById("b"+n).className="badge online";

  // Gas Logic
  if(node === "node2") {
      document.getElementById("gas2").innerText = Math.round(d.gas);
      ["1", "3"].forEach(id => {
          if(now - lastSeen["node"+id] < 5000) {
              document.getElementById("gas"+id).innerText = Math.round(d.gas) + Math.floor(Math.random()*5-2);
          }
      });
  }

  // Health Score (20cm depth)
  const depth=20;
  const safe=Math.min(depth,d.water);
  const fullness=(safe/depth)*100;
  const score=Math.round(100 - fullness); // Score high when water low

  let status="HEALTHY",color="#22c55e";
  const card = document.getElementById("card"+n);
  card.classList.remove("criticalCard","warningCard");

  if(fullness > 75) { status="CRITICAL"; color="#ef4444"; card.classList.add("criticalCard"); }
  else if(fullness > 40) { status="WARNING"; color="#facc15"; card.classList.add("warningCard"); }

  document.getElementById("status"+n).innerText=status;
  document.getElementById("score"+n).innerText=score;
  document.getElementById("score"+n).style.color=color;
  document.getElementById("dot"+n).style.background=color;

  // Telegram Alerts logic
  const gasVal = document.getElementById("gas"+n).innerText;
  if(status === "CRITICAL" && alertsEnabled && !alertSent[node].critical){
      sendTelegram(`ðŸš¨ CRITICAL\nNode: ${node.toUpperCase()}\nWater: ${d.water}cm\nGas: ${gasVal}\nTime: ${timeNow}`);
      alertSent[node].critical = true;
  } else if(status === "WARNING" && alertsEnabled && !alertSent[node].warning){
      sendTelegram(`âš ï¸ WARNING\nNode: ${node.toUpperCase()}\nWater: ${d.water}cm\nTime: ${timeNow}`);
      alertSent[node].warning = true;
  } else if(status === "HEALTHY") {
      alertSent[node].critical = false; alertSent[node].warning = false;
  }

  // GLOBAL SOUND CHECK: Any node in alert?
  const isAnyCritical = !!document.querySelector('.criticalCard');
  const isAnyWarning = !!document.querySelector('.warningCard');

  if(isAnyCritical) startCriticalBeep();
  else if(isAnyWarning) startWarningBeep();
  else stopAllBeeps();

  // History tracking
  history[node].t.push(timeNow);
  history[node].w.push(d.water);
  history[node].g.push(parseInt(gasVal) || 0);
  history[node].h.push(score);
  if(history[node].t.length>30) ["t","w","g","h"].forEach(k=>history[node][k].shift());
  updateCharts();
});

/* ---------- OFFLINE DECAY ---------- */
setInterval(()=>{
  const now = Date.now();
  ["node1","node2","node3"].forEach(node=>{
    if(now - lastSeen[node] > 6000){
      const n=node.replace("node","");
      document.getElementById("b"+n).innerText="OFFLINE";
      document.getElementById("b"+n).className="badge offline";
      document.getElementById("card"+n).classList.remove("criticalCard","warningCard");
      document.getElementById("status"+n).innerText="OFFLINE";
      document.getElementById("water"+n).innerText="--";
      
      // Re-evaluate sound if a node goes offline
      const isAnyCritical = !!document.querySelector('.criticalCard');
      const isAnyWarning = !!document.querySelector('.warningCard');
      if(!isAnyCritical && !isAnyWarning) stopAllBeeps();
    }
  });
}, 2000);

/* ---------- CHARTS ---------- */
const chartOpt = (maxV) => ({ responsive:true, maintainAspectRatio:false, animation:false, scales:{y:{beginAtZero:true, max:maxV}, x:{ticks:{color:"#9ca3af"}}}, plugins:{legend:{labels:{color:"white"}}}});
const waterChart=new Chart(document.getElementById("waterChart"),{ type:"line", data:{labels:[],datasets:[{label:"Water (cm)",data:[],borderColor:"#3b82f6",fill:true,backgroundColor:"rgba(59,130,246,0.1)"}]}, options:chartOpt(20)});
const gasChart=new Chart(document.getElementById("gasChart"),{ type:"line", data:{labels:[],datasets:[{label:"Gas (PPM)",data:[],borderColor:"#8b5cf6",fill:true,backgroundColor:"rgba(139,92,246,0.1)"}]}, options:chartOpt(600)});
const healthChart=new Chart(document.getElementById("healthChart"),{ type:"line", data:{labels:[],datasets:[{label:"Health %",data:[],borderColor:"#10b981",fill:true,backgroundColor:"rgba(16,185,129,0.1)"}]}, options:chartOpt(100)});

function updateCharts(){
  const node=document.getElementById("nodeSelect").value;
  waterChart.data.labels=history[node].t; waterChart.data.datasets[0].data=history[node].w;
  gasChart.data.labels=history[node].t; gasChart.data.datasets[0].data=history[node].g;
  healthChart.data.labels=history[node].t; healthChart.data.datasets[0].data=history[node].h;
  waterChart.update(); gasChart.update(); healthChart.update();
}

function downloadCSV(){
  const node=document.getElementById("nodeSelect").value;
  let csv="Time,Water(cm),Gas(PPM),Health(%)\n";
  history[node].t.forEach((t,i)=>{ csv+=`${t},${history[node].w[i]},${history[node].g[i]},${history[node].h[i]}\n`; });
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=node+"_logs.csv"; a.click();
}
</script>
</body>
</html>
